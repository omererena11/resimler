<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=5, user-scalable=yes">
  <title>Viewer</title>
  <style>
    html, body { margin:0; padding:0; height:100%; background:#000; overflow:hidden; }
    #viewer{
      display:flex; width:100%; height:100%;
      overflow-x:auto; overflow-y:hidden;
      scroll-snap-type:x mandatory;
      -webkit-overflow-scrolling:touch;
      scroll-behavior:smooth;
    }
    .page{
      min-width:100vw; height:100vh;
      display:flex; justify-content:center; align-items:center;
      scroll-snap-align:start; background:#000;
    }
    .page img{
      max-width:100%; max-height:100%;
      object-fit:contain;
    }
    #counter{
      position:fixed; left:50%; bottom:12px; transform:translateX(-50%);
      background:rgba(0,0,0,.55); color:#fff;
      font:500 14px system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
      padding:6px 10px; border-radius:999px;
    }
  </style>
</head>
<body>
  <div id="viewer"></div>
  <div id="counter">- / -</div>

<script>
(function(){
  const qs = new URLSearchParams(location.search);

  // m: manifest URL, x: pipe/satır-listesi, xj: JSON liste
  const mParam  = qs.get('m')  || '';
  const xParam  = qs.get('x')  || '';
  const xjParam = qs.get('xj') || '';
  const startPage = Math.max(1, parseInt(qs.get('p') || '1', 10)); // 1-based

  const viewer  = document.getElementById('viewer');
  const counter = document.getElementById('counter');

  // --- Yardımcılar ---
  const decodePlus = s => decodeURIComponent((s || '').replace(/\+/g, '%20'));

  function normalizeLines(txt){
    return txt.replace(/\r\n/g, '\n').replace(/\r/g, '\n').split('\n')
              .map(s => s.trim()).filter(Boolean);
  }

  function splitExtraFromX(txt){
    const t = decodePlus(txt).trim();
    if(!t) return [];
    // Hem | hem de satır sonu desteklenir
    return t.split(/\r?\n|\|/).map(s => s.trim()).filter(Boolean);
  }

  function parseJsonList(txt){
    if(!txt) return [];
    try{
      const raw = decodePlus(txt);
      const arr = JSON.parse(raw);
      if(Array.isArray(arr)){
        return arr.map(v => String(v || '').trim()).filter(Boolean);
      }
    }catch(e){ /* yut */ }
    return [];
  }

  function sanitizeUrls(arr){
    // boşları at, kopyaları kaldır, http(s) dışını at
    const seen = new Set();
    const out = [];
    for(const u of arr){
      const s = (u || '').trim();
      if(!s) continue;
      if(!/^https?:\/\//i.test(s)) continue;
      if(seen.has(s)) continue;
      seen.add(s);
      out.push(s);
    }
    return out;
  }

  async function getManifestLines(url){
    if(!url) return [];
    try{
      const res = await fetch(url, {cache:'no-store'});
      const txt = await res.text();
      return normalizeLines(txt);
    }catch(e){
      console.error('Manifest alınamadı:', e);
      return [];
    }
  }

  function buildPages(urls){
    viewer.innerHTML = '';
    urls.forEach(u => {
      const page = document.createElement('div');
      page.className = 'page';
      const img = document.createElement('img');
      img.loading = 'lazy';
      img.decoding = 'async';
      img.src = u;
      page.appendChild(img);
      viewer.appendChild(page);
    });
    updateCounter();
    const idx = Math.min(Math.max(1, startPage), urls.length) - 1;
    if(viewer.children[idx]){
      viewer.children[idx].scrollIntoView({behavior:'instant'});
    }
  }

  function updateCounter(){
    const pageWidth = viewer.clientWidth || 1;
    const idx = Math.round(viewer.scrollLeft / pageWidth) + 1;
    const total = viewer.children.length;
    counter.textContent = total ? (idx + ' / ' + total) : '- / -';
  }

  viewer.addEventListener('scroll', () => {
    requestAnimationFrame(updateCounter);
  }, {passive:true});

  (async function init(){
    // 1) Uygulamadan gelen ekstra liste:
    //    Tercih: xj (JSON liste). Alternatif: x (pipe/satır).
    const extrasFromJson = parseJsonList(xjParam);
    const extrasFromText = splitExtraFromX(xParam);
    const extras = sanitizeUrls([ ...extrasFromJson, ...extrasFromText ]);

    // 2) Manifest (varsa)
    const lines = sanitizeUrls(await getManifestLines(mParam));

    // 3) Birleştir (önce extras, sonra manifest)
    const urls = [ ...extras, ...lines ];

    if(!urls.length){
      viewer.innerHTML = '<div class="page"><span style="color:#fff">Manifest boş veya ekstra link gelmedi.</span></div>';
      updateCounter();
      return;
    }

    buildPages(urls);
  })();
})();
</script>
</body>
</html>
