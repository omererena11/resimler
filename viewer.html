<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=5, user-scalable=yes"/>
<meta name="referrer" content="no-referrer"/>
<title>Viewer</title>
<style>
  html, body{
    margin:0; padding:0; height:100%; background:#000; overflow:hidden;
    overscroll-behavior-x:contain; font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;
  }
  #viewer{
    display:flex; width:100%; height:100%;
    overflow-x:auto; overflow-y:hidden;
    scroll-snap-type:x mandatory;
    -webkit-overflow-scrolling:touch;
    scroll-behavior:smooth; position:relative;
  }
  .page{
    min-width:100vw; height:100vh;
    display:flex; justify-content:center; align-items:center;
    scroll-snap-align:start; scroll-snap-stop:always; /* üëà tek tek yakala */
    background:#000; position:relative; overflow:hidden;
  }
  .pz{ width:100%; height:100%; display:flex; justify-content:center; align-items:center; position:relative; touch-action:none; }
  .img{
    max-width:100%; max-height:100%; object-fit:contain; background:#000;
    opacity:0; transition:opacity .18s ease; /* √∂nceki resmin ‚Äúflash‚Äùƒ±nƒ± engeller */
  }
  .img.ready{ opacity:1; }
  .skel{
    position:absolute; inset:0; background:
      radial-gradient(circle at 50% 45%, #1a1a1a 0 20%, #0a0a0a 60%);
    animation:pulse 1.2s ease-in-out infinite;
  }
  @keyframes pulse{50%{filter:brightness(1.15)}}
  #err{
    position:absolute; inset:auto 12px 12px 12px; color:#bbb; background:#111a; padding:8px 10px; border-radius:8px; font-size:14px; display:none;
  }
</style>
</head>
<body>
  <div id="viewer"></div>
  <div id="err"></div>

<script>
(function(){
  const $ = sel => document.querySelector(sel);
  const viewer = $("#viewer");
  const errBox = $("#err");

  // ---------- Yardƒ±mcƒ±lar ----------
  const qp = new URLSearchParams(location.search);
  const rawM = qp.get("m") || qp.get("manifest") || qp.get("u") || qp.get("url");
  const rawX = qp.get("x") || qp.get("extra") || "";
  const manifestURL = rawM ? safeDecode(rawM) : "";
  const extraList = splitList(safeDecode(rawX));

  function safeDecode(s){ try{ return decodeURIComponent(s); }catch{ return s||""; } }
  function splitList(s){
    if(!s) return [];
    return s.split(/\r?\n|\|/g).join(",").split(",")
            .map(t=>t.trim()).filter(isLink);
  }
  function isLink(t){ return /^https?:\/\//i.test(t) || /^file:\/\/\/android_asset\//i.test(t); }

  function showErr(msg){
    errBox.textContent = msg;
    errBox.style.display = "block";
    console.warn(msg);
  }

  // App Inventor / Kodular / Niotron WebViewString desteƒüi (opsiyonel)
  function getWVStr(){
    try{
      if (window.AppInventor && typeof window.AppInventor.getWebViewString === "function"){
        return String(window.AppInventor.getWebViewString() || "");
      }
    }catch(e){}
    return "";
  }

  async function readManifest(src){
    // src bir URL ise √ßek; deƒüilse satƒ±r satƒ±r liste kabul et
    if (isLink(src)) {
      try{
        const resp = await fetch(src, {cache:"no-store", mode:"cors"});
        if(!resp.ok) throw new Error("HTTP " + resp.status);
        const text = await resp.text();
        return text.split(/\r?\n/).map(t=>t.trim()).filter(isLink);
      }catch(e){
        showErr("Manifest okunamadƒ±: " + e.message);
        return [];
      }
    } else {
      // satƒ±r satƒ±r metin
      return src.split(/\r?\n/).map(t=>t.trim()).filter(isLink);
    }
  }

  function dedupe(arr){
    const out=[]; const seen=new Set();
    for(const u of arr){
      const k = u.trim();
      if(!k) continue;
      if(!seen.has(k)){ seen.add(k); out.push(k); }
    }
    return out;
  }

  function makePage(url){
    const page = document.createElement("div");
    page.className = "page";
    const pz = document.createElement("div"); pz.className="pz";
    const sk = document.createElement("div"); sk.className="skel";
    const img = document.createElement("img"); img.className="img"; img.setAttribute("data-src", url);
    pz.appendChild(sk); pz.appendChild(img); page.appendChild(pz);
    return {page, img, sk};
  }

  function lazyLoad(img, sk, io){
    img.onload = ()=>{ sk.remove(); img.classList.add("ready"); };
    img.onerror = ()=>{ sk.remove(); img.alt="G√∂r√ºnt√º y√ºklenemedi"; img.classList.add("ready"); };
    io.observe(img);
  }

  // Kaydƒ±rma bittiƒüinde en yakƒ±n sayfaya oturt (fazla atlamayƒ± engeller)
  function attachSnapFix(){
    let t; viewer.addEventListener("scroll", ()=>{
      clearTimeout(t);
      t = setTimeout(()=>{
        const w = viewer.clientWidth;
        const target = Math.round(viewer.scrollLeft / w) * w;
        viewer.scrollTo({left:target, behavior:"smooth"});
      }, 80);
    });
  }

  // ---------- Ba≈ülat ----------
  (async function init(){
    let list = [];
    if (manifestURL) {
      list = await readManifest(manifestURL);
    } else {
      // App side'dan WebViewString gelebilir (URL ya da satƒ±r listesi)
      const wvs = getWVStr();
      if (wvs){
        try{
          const d = JSON.parse(wvs);
          if (d && d.manifest) list = await readManifest(String(d.manifest));
          if (Array.isArray(d.extra)) list = (d.extra.filter(isLink)).concat(list);
        }catch{
          // JSON deƒüilse d√ºz metin/URL olarak dene
          if (isLink(wvs)) list = await readManifest(wvs);
          else list = wvs.split(/\r?\n/).map(t=>t.trim()).filter(isLink);
        }
      }
    }

    // x param ile gelen ekstra linkleri ba≈üa ekle ‚Üí kopyalarƒ± sil
    list = dedupe(extraList.concat(list));

    if (!list.length){
      showErr("G√∂sterilecek resim bulunamadƒ±. (Parametre: m / manifest / u / url veya WebViewString ile g√∂nderin.)");
      // En azƒ±ndan bo≈ü bir sayfa olsun:
      viewer.innerHTML = '<div class="page"><div class="pz"><div class="skel"></div></div></div>';
      attachSnapFix();
      return;
    }

    // DOM‚Äôa ekle ve lazy-load hazƒ±rla
    const io = new IntersectionObserver(entries=>{
      entries.forEach(e=>{
        if(e.isIntersecting){
          const img = e.target;
          io.unobserve(img);
          const src = img.getAttribute("data-src");
          // ‚Äú√∂nceki resim g√∂z√ºkt√º‚Äù sorununu engellemek i√ßin src‚Äôyi tam bu anda veriyoruz
          img.src = src;
        }
      });
    }, {root:viewer, rootMargin:"50px", threshold:0.15});

    const frag = document.createDocumentFragment();
    for(const url of list){
      const {page, img, sk} = makePage(url);
      frag.appendChild(page);
      lazyLoad(img, sk, io);
    }
    viewer.appendChild(frag);

    attachSnapFix();
  })();

})();
</script>
</body>
</html>
