<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=5, user-scalable=no"/>
<meta name="referrer" content="no-referrer"/>
<title>Viewer (Any-Point Zoom • Robust Source Loading)</title>
<style>
  html, body{
    margin:0; padding:0; height:100%; background:#000; overflow:hidden;
    overscroll-behavior-x:contain; font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;
    -webkit-user-select:none; user-select:none;
  }
  #viewer{
    display:flex; width:100%; height:100%;
    overflow-x:auto; overflow-y:hidden;
    scroll-snap-type:x mandatory;
    -webkit-overflow-scrolling:touch;
    scroll-behavior:smooth; position:relative;
  }
  #viewer.lock{ scroll-snap-type:none; }

  .page{
    min-width:100vw; height:100vh;
    display:flex; justify-content:center; align-items:center;
    scroll-snap-align:start; scroll-snap-stop:always;
    background:#000; position:relative; overflow:hidden;
  }

  .pz{
    width:100%; height:100%;
    position:relative;
    touch-action: pan-x pan-y;   /* pinch/drag sırasında JS none yapacak */
  }

  /* Transform edilen sahne */
  .stage{
    position:absolute; inset:0;
    transform-origin: 0 0;
    will-change: transform;
    backface-visibility:hidden;
    transform: translate(0px,0px) scale(1);
  }

  .img{
    position:absolute; inset:0;
    width:100%; height:100%;
    object-fit:contain;
    background:#000;
    opacity:0; transition:opacity .18s ease;
    -webkit-user-drag:none; user-drag:none; pointer-events:auto;
  }
  .img.ready{ opacity:1; }

  .skel{
    position:absolute; inset:0; background:
      radial-gradient(circle at 50% 45%, #1a1a1a 0 20%, #0a0a0a 60%);
    animation:pulse 1.2s ease-in-out infinite;
  }
  @keyframes pulse{50%{filter:brightness(1.15)}}

  #counter{
    position:fixed; left:50%; bottom:20px; transform:translateX(-50%);
    z-index:10; background:#111a; color:#fff;
    padding:10px 14px; border-radius:12px; font-size:28px; font-weight:700;
  }

  .navbtn{
    position:fixed; top:50%; transform:translateY(-50%);
    width:42px; height:64px; z-index:11; border:none; border-radius:12px;
    background:#111a; color:#ddd; font-size:22px;
    display:flex; align-items:center; justify-content:center;
  }
  .navbtn:active{filter:brightness(1.2)}
  #prev{ left:8px; display:none; }
  #next{ right:8px; }

  #err{
    position:absolute; inset:auto 12px 12px 12px; color:#bbb; background:#111a; padding:8px 10px; border-radius:8px; font-size:14px; display:none; max-width:min(92vw,800px);
    white-space:pre-wrap; line-height:1.35;
  }
</style>
</head>
<body>
  <div id="viewer"></div>
  <button id="prev" class="navbtn" aria-label="Önceki">‹</button>
  <button id="next" class="navbtn" aria-label="Sonraki">›</button>
  <div id="counter" hidden>— / —</div>
  <div id="err"></div>

<script>
(function(){
  const $ = sel => document.querySelector(sel);
  const viewer = $("#viewer");
  const counter = $("#counter");
  const btnPrev = $("#prev");
  const btnNext = $("#next");
  const errBox = $("#err");

  // -------- Yardımcılar --------
  const qp = new URLSearchParams(location.search);
  const rawM = qp.get("m") || qp.get("manifest") || qp.get("u") || qp.get("url");
  const rawX = qp.get("x") || qp.get("extra") || "";

  function safeDecode(s){ try{ return decodeURIComponent(s); }catch{ return s||""; } }
  function isLink(t){ return /^https?:\/\//i.test(t) || /^file:\/\/\/android_asset\//i.test(t); }
  function endsLikeImage(u){ return /\.(avif|webp|jpe?g|png|gif|bmp|svg|heic|heif)(\?|#|$)/i.test(u); }
  function splitMulti(s){
    if(!s) return [];
    return s.split(/\r?\n|\||,/g).map(t=>t.trim()).filter(Boolean);
  }
  function showErr(msg){
    errBox.textContent = msg;
    errBox.style.display = "block";
    console.warn(msg);
  }
  function dedupe(arr){
    const out=[]; const seen=new Set();
    for(const u of arr){ const k=(u||"").trim(); if(k && !seen.has(k)){ seen.add(k); out.push(k); } }
    return out;
  }

  // -------- Kaynak listesi çıkarma (CORS dayanıklı) --------
  async function buildList(){
    const extraList = splitMulti(safeDecode(rawX)).filter(isLink);
    const m = safeDecode(rawM || "");

    // 1) x/extra içindekileri topla
    let list = [...extraList];

    if (m){
      // 2) m link ise…
      if (isLink(m)){
        // 2a) m zaten doğrudan görsel(ler) olabilir:
        // - birden çok linki virgül/pipe/newline ile verdiyse: parçala
        const parts = splitMulti(m).filter(isLink);
        if (parts.length > 1) {
          list = list.concat(parts);
        } else if (endsLikeImage(m)) {
          // 2b) tekil görsel linkiyse: doğrudan ekle (manifest fetch ETME!)
          list.push(m);
        } else {
          // 2c) gerçekten manifest dosyasıysa: fetch dene; CORS olursa sessizce geç
          try{
            const resp = await fetch(m, {cache:"no-store", mode:"cors"});
            if(!resp.ok) throw new Error("HTTP " + resp.status);
            const text = await resp.text();
            const lines = text.split(/\r?\n/).map(t=>t.trim()).filter(isLink);
            list = list.concat(lines);
          }catch(e){
            // CORS/403/404 olduysa, m'yi tekil görsel san ve ekle (son çare)
            if (endsLikeImage(m)) list.push(m);
            else showErr("Manifest okunamadı: " + e.message + "\nNot: m= parametresine doğrudan görsel URL’leri virgül/|/satırla tek satıra da yazabilirsin.");
          }
        }
      } else {
        // 3) m düz metinse (ör. birden çok URL tek param): parçalayıp ekle
        const parts = splitMulti(m).filter(isLink);
        list = list.concat(parts);
      }
    }

    list = dedupe(list);
    return list;
  }

  // -------- Sayfa üretimi --------
  function makePage(url, idx){
    const page = document.createElement("div");
    page.className = "page"; page.dataset.index = idx;

    const pz = document.createElement("div"); pz.className="pz";
    const stage = document.createElement("div"); stage.className="stage";
    const sk = document.createElement("div"); sk.className="skel";
    const img = document.createElement("img"); img.className="img";
    img.setAttribute("data-src", url);

    stage.appendChild(img);
    pz.appendChild(sk);
    pz.appendChild(stage);
    page.appendChild(pz);

    attachZoomPan(pz, stage);  // transform stage üzerinde (Maps tarzı)
    return {page, img, sk};
  }

  // -------- Yükleme (garanti) --------
  function loadImageAt(index){
    const page = viewer.querySelector(`.page[data-index="${index}"]`);
    if(!page) return;
    const img = page.querySelector(".img");
    const sk  = page.querySelector(".skel");
    if(!img || img.dataset.loaded) return;

    const src = img.getAttribute("data-src");
    if(!src){ sk && sk.remove(); return; }

    // Bazı sunucular "no-referrer" sevmez → refererPolicy'i varsayılan bırakıyoruz.
    // Gerekirse: img.referrerPolicy = "no-referrer";

    // onload/onerror + failsafe:
    let done = false;
    const markReady = ()=>{
      if (done) return;
      done = true;
      sk && sk.remove();
      img.classList.add("ready");
    };

    img.onload  = markReady;
    img.onerror = (e)=>{ console.warn("IMG error:", src, e); markReady(); img.alt="Görüntü yüklenemedi"; };

    img.src = src;                // isteği başlat
    img.dataset.loaded = "1";

    // bazı webview/sunucu kombinasyonlarında onload tetiklenmeyebilir → failsafe
    setTimeout(markReady, 1200);
  }

  function clamp(n,a,b){ return Math.max(a, Math.min(b, n)); }

  // -------- Sayaç / gezinme --------
  let total = 0;
  function currentIndex(){
    const w = viewer.clientWidth || 1;
    return clamp(Math.round(viewer.scrollLeft / w), 0, Math.max(0, total-1));
  }
  function updateVisible(){
    const idx = currentIndex();
    loadImageAt(idx);
    loadImageAt(idx-1);
    loadImageAt(idx+1);
    counter.hidden = false;
    counter.textContent = `${idx+1} / ${total}`;
    btnPrev.style.display = (idx === 0) ? "none" : "flex";
    btnNext.style.display = (idx === total-1) ? "none" : "flex";
  }

  let snapTimer;
  function onScroll(){
    clearTimeout(snapTimer);
    snapTimer = setTimeout(()=>{
      const w = viewer.clientWidth;
      const target = Math.round(viewer.scrollLeft / w) * w;
      viewer.scrollTo({left: target, behavior:"smooth"});
      updateVisible();
    }, 80);
  }

  function go(delta){
    const w = viewer.clientWidth;
    const idx = currentIndex();
    const targetIdx = clamp(idx + delta, 0, total - 1);
    viewer.scrollTo({left: targetIdx * w, behavior:"smooth"});
    loadImageAt(targetIdx);
    loadImageAt(targetIdx-1);
    loadImageAt(targetIdx+1);
    counter.textContent = `${targetIdx+1} / ${total}`;
    btnPrev.style.display = (targetIdx === 0) ? "none" : "flex";
    btnNext.style.display = (targetIdx === total-1) ? "none" : "flex";
  }
  btnPrev.addEventListener("click", ()=>go(-1));
  btnNext.addEventListener("click", ()=>go(1));

  // =======================
  //   ZOOM + PAN (STAGE) — Any-Point Anchor
  // =======================
  function attachZoomPan(container, stage){
    const state = {
      scale: 1, min: 1, max: 4,
      tx: 0, ty: 0,
      dragging: false, lx:0, ly:0,
      rafPending:false, targetTransform:"translate(0px,0px) scale(1)"
    };
    const PINCH_START_THRESHOLD_PX = 10;
    const STEP_CAP = 0.14;
    const WHEEL_SENS = 0.0011;

    const clamp = (n,a,b)=>Math.max(a,Math.min(b,n));

    function perfLock(on){
      if(on){
        viewer.classList.add("lock");
        viewer.style.webkitOverflowScrolling = "auto";
        viewer.style.scrollBehavior = "auto";
        container.style.touchAction = "none";
      }else{
        viewer.style.webkitOverflowScrolling = "touch";
        viewer.style.scrollBehavior = "smooth";
        container.style.touchAction = "pan-x pan-y";
        if (state.scale<=1.0001) viewer.classList.remove("lock");
      }
    }

    function schedule(){
      if(state.rafPending) return;
      state.rafPending = true;
      requestAnimationFrame(()=>{ stage.style.transform = state.targetTransform; state.rafPending=false; });
    }
    function compose(){ return `translate(${state.tx}px, ${state.ty}px) scale(${state.scale})`; }

    function clampPan(){
      const cw = container.clientWidth, ch = container.clientHeight;
      const exX = cw * state.scale - cw;
      const exY = ch * state.scale - ch;
      const minTx = -Math.max(0, exX);
      const maxTx =  Math.max(0, exX);
      const minTy = -Math.max(0, exY);
      const maxTy =  Math.max(0, exY);
      state.tx = clamp(state.tx, minTx, maxTx);
      state.ty = clamp(state.ty, minTy, maxTy);
      state.targetTransform = compose(); schedule();
    }

    function zoomAt(clientX, clientY, nextScale){
      nextScale = clamp(nextScale, state.min, state.max);
      const prev = state.scale;
      if (Math.abs(nextScale - prev) < 1e-6) return;

      const rect = container.getBoundingClientRect();
      const cx = clientX - rect.left;
      const cy = clientY - rect.top;

      // world = (p - T)/S  →  T' = p - world * S'
      const wx = (cx - state.tx) / prev;
      const wy = (cy - state.ty) / prev;

      state.scale = nextScale;
      state.tx = cx - wx * nextScale;
      state.ty = cy - wy * nextScale;

      clampPan();
    }

    // Wheel (opsiyonel)
    container.addEventListener("wheel", (e)=>{
      e.preventDefault();
      const raw = Math.exp(-e.deltaY * WHEEL_SENS);
      const factor = clamp(raw, 1-STEP_CAP, 1+STEP_CAP);
      zoomAt(e.clientX, e.clientY, state.scale * factor);
      perfLock(state.scale>1.0001);
      clearTimeout(container._wheelEndT);
      container._wheelEndT = setTimeout(()=>{ if(state.scale<=1.0001) perfLock(false); }, 120);
    }, {passive:false});

    // Pointer Events
    let p1=null, p2=null, pinchActive=false, pinchStartDist=0, pinchStartScale=1;

    container.addEventListener("pointerdown", (e)=>{
      container.setPointerCapture(e.pointerId);
      if (!p1) p1={id:e.pointerId,x:e.clientX,y:e.clientY};
      else if (!p2 && e.pointerId!==p1.id) p2={id:e.pointerId,x=e.clientX,y=e.clientY};

      if (!p2 && state.scale>1){
        state.dragging = true; state.lx = e.clientX; state.ly = e.clientY;
        perfLock(true);
      }
      if (p1 && p2){
        pinchActive=false;
        pinchStartDist = Math.hypot(p2.x-p1.x, p2.y-p1.y);
        pinchStartScale = state.scale;
        perfLock(true);
      }
    });

    container.addEventListener("pointermove", (e)=>{
      if (p1 && e.pointerId===p1.id){ p1.x=e.clientX; p1.y=e.clientY; }
      if (p2 && e.pointerId===p2.id){ p2.x=e.clientX; p2.y=e.clientY; }

      // PINCH
      if (p1 && p2){
        e.preventDefault();
        const dist = Math.hypot(p2.x-p1.x, p2.y-p1.y);
        if (!pinchActive){
          if (Math.abs(dist - pinchStartDist) < PINCH_START_THRESHOLD_PX) return;
          pinchActive = true;
          pinchStartDist = dist;
          pinchStartScale = state.scale;
        }
        const cx=(p1.x+p2.x)/2, cy=(p1.y+p2.y)/2;
        const next = pinchStartScale * (dist / (pinchStartDist || 1));
        zoomAt(cx, cy, next);
        return;
      }

      // PAN
      if (state.dragging && state.scale>1){
        e.preventDefault();
        const dx = e.clientX - state.lx;
        const dy = e.clientY - state.ly;
        state.lx = e.clientX; state.ly = e.clientY;
        state.tx += dx; state.ty += dy;
        clampPan();
      }
    }, {passive:false});

    function endPointer(e){
      if (p1 && e.pointerId===p1.id) p1=null;
      if (p2 && e.pointerId===p2.id) p2=null;

      if (!(p1&&p2)) pinchActive=false;

      if (!p1 && !p2){
        state.dragging=false;
        if (state.scale<=1.0001){
          state.scale=1; state.tx=0; state.ty=0;
          state.targetTransform='translate(0px,0px) scale(1)'; schedule();
          perfLock(false);
        }else{
          perfLock(true);
        }
      }
    }
    container.addEventListener("pointerup", endPointer);
    container.addEventListener("pointercancel", endPointer);
    container.addEventListener("pointerleave", endPointer);
  }

  // -------- Başlat --------
  (async function init(){
    let list = await buildList();

    if (!list.length){
      showErr(
        "Gösterilecek resim bulunamadı.\n" +
        "Kullanım örnekleri:\n" +
        "• ?u=https://site/img1.jpg|https://site/img2.jpg\n" +
        "• ?x=https://a.com/1.jpg, https://b.com/2.png\n" +
        "• ?m=https://site/manifest.txt   (satır satır URL)\n" +
        "• ?m=https://site/1.jpg|https://site/2.jpg  (fetch yapmadan çoklu URL)"
      );
      // En azından tek boş sayfa göster
      viewer.innerHTML = '<div class="page" data-index="0"><div class="pz"><div class="skel"></div></div></div>';
      counter.hidden = false; counter.textContent = `1 / 1`;
      return;
    }

    // DOM’a dök
    const frag = document.createDocumentFragment();
    list.forEach((url, i)=>{
      const {page} = makePage(url, i);
      frag.appendChild(page);
    });
    viewer.appendChild(frag);
    const total = list.length;
    window.__TOTAL = total; // debug
    // İlk 3 sayfayı garanti başlat
    loadImageAt(0); loadImageAt(1); loadImageAt(2);

    // Sayaç/oklar ve scroll dinleyicileri
    counter.hidden = false; counter.textContent = `1 / ${total}`;
    btnPrev.style.display = "none";
    btnNext.style.display = (total<=1) ? "none" : "flex";

    viewer.addEventListener("scroll", onScroll);
    window.addEventListener("resize", ()=>{ /* gerekirse */ });
  })();
})();
</script>
</body>
</html>
