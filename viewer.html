<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=5, user-scalable=yes" />
  <title>Brochure Viewer</title>
  <style>
    html, body { margin:0; padding:0; height:100%; background:#000; overflow:hidden; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .wrap{ position:relative; width:100vw; height:100vh; display:flex; align-items:center; justify-content:center; }

    /* viewport + track for sliding */
    .viewport{ position:absolute; inset:0; overflow:hidden; }
    .track{ width:200%; height:100%; display:flex; transform:translateX(0); }
    .slot{ flex:0 0 100%; width:100%; height:100%; object-fit:contain; background:#000; }
    .anim{ transition: transform .28s ease-out; }

    /* Overlay */
    .hud{ position:absolute; left:0; right:0; bottom:0; display:flex; align-items:center; justify-content:space-between; gap:.5rem; padding:.6rem .8rem; background:linear-gradient(180deg, rgba(0,0,0,0) 0%, rgba(0,0,0,.55) 35%, rgba(0,0,0,.8) 100%); color:#fff; user-select:none; }
    .btn{ display:inline-flex; align-items:center; justify-content:center; min-width:42px; height:42px; padding:0 .6rem; border-radius:999px; background:rgba(255,255,255,.12); border:1px solid rgba(255,255,255,.25); font-weight:600; cursor:pointer; }
    .btn:active{ transform:scale(.98); }
    .btn[disabled]{ opacity:.35; pointer-events:none; }
    .ctr{ font-weight:700; letter-spacing:.3px; padding:0 .4rem; min-width:92px; text-align:center; }

    /* Top toast */
    .toast{ position:absolute; top:.6rem; left:50%; transform:translateX(-50%); background:rgba(0,0,0,.65); color:#fff; padding:.4rem .7rem; border-radius:8px; font-size:.9rem; display:none; }

    /* Tap zones for mobile (optional) */
    .zone{ position:absolute; top:0; bottom:0; width:33.3333%; }
    .left{ left:0; }
    .right{ right:0; }
  </style>
</head>
<body>
  <div class="wrap" id="wrap">
    <div class="viewport">
      <div id="track" class="track">
        <img id="slotA" class="slot" alt="Broşür">
        <img id="slotB" class="slot" alt="Broşür">
      </div>
    </div>

    <!-- quick tap zones for phones -->
    <div class="zone left" id="zl" aria-hidden="true"></div>
    <div class="zone right" id="zr" aria-hidden="true"></div>

    <div class="hud">
      <button id="btnPrev" class="btn" aria-label="Geri">⟵</button>
      <div id="counter" class="ctr">– / –</div>
      <button id="btnNext" class="btn" aria-label="İleri">⟶</button>
    </div>
    <div class="toast" id="toast"></div>
  </div>

<script>
(function(){
  const qs = new URLSearchParams(location.search);
  const manifestUrl = qs.get('m'); // manifest url (required)
  let startIndex = parseInt(qs.get('p') || '1', 10) - 1; // optional start page (1-based)

  const counter = document.getElementById('counter');
  const btnPrev = document.getElementById('btnPrev');
  const btnNext = document.getElementById('btnNext');
  const toast = document.getElementById('toast');
  const zl = document.getElementById('zl');
  const zr = document.getElementById('zr');
  const track = document.getElementById('track');
  const slotA = document.getElementById('slotA');
  const slotB = document.getElementById('slotB');

  let urls = [];
  let i = 0;           // current index
  let active = 'A';    // which slot currently shows the active page
  let animating = false;

  if(!manifestUrl){ showToast('Manifest parametresi eksik: ?m=ENCODED_URL'); return; }

  // Helpers
  function showToast(t){ toast.textContent = t; toast.style.display='block'; clearTimeout(showToast._t); showToast._t = setTimeout(()=>toast.style.display='none', 1600); }
  function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }
  function updateHUD(){
    counter.textContent = `${urls.length ? (i+1) : '–'} / ${urls.length || '–'}`;
    btnPrev.disabled = (i<=0);
    btnNext.disabled = (i>=urls.length-1);
  }
  function preload(idx){ if(idx>i && idx<urls.length){ const im = new Image(); im.src = urls[idx]; } }

  function setSlot(slot, src){ (slot==='A'?slotA:slotB).src = src; }

  function immediateShow(idx){
    // no animation (initial render)
    i = clamp(idx, 0, urls.length-1);
    setSlot('A', urls[i]);
    setSlot('B', urls[i]);
    active = 'A';
    updateHUD();
    preload(i+1);
  }

  function slideTo(newIdx, dir){
    if(animating) return; // prevent double taps
    if(newIdx<0 || newIdx>=urls.length) return;
    animating = true;

    const nextSlot = (active==='A') ? 'B' : 'A';
    setSlot(nextSlot, urls[newIdx]);

    // prepare starting position
    track.classList.remove('anim');
    track.style.transform = 'translateX(0)';
    // force reflow
    void track.offsetWidth;

    // animate to direction
    track.classList.add('anim');
    track.style.transform = (dir>0) ? 'translateX(-100%)' : 'translateX(100%)';

    track.addEventListener('transitionend', function handler(){
      track.removeEventListener('transitionend', handler);
      // swap active slot
      active = nextSlot;
      i = newIdx;
      updateHUD();
      preload(i+1);

      // reset track back to 0 without animation and mirror current image into the other slot
      track.classList.remove('anim');
      track.style.transform = 'translateX(0)';
      const passive = (active==='A') ? 'B' : 'A';
      setSlot(passive, urls[i]);
      animating = false;
    });
  }

  async function load(){
    try{
      const res = await fetch(manifestUrl, { cache:'no-store' });
      const text = await res.text();
      urls = text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean).filter(s=>/\.(webp|jpg|jpeg|png)$/i.test(s));
      if(!urls.length){ showToast('Manifest boş veya geçersiz.'); return; }
      if(!(startIndex>=0 && startIndex<urls.length)) startIndex = 0;
      immediateShow(startIndex);
    }catch(e){ console.error(e); showToast('Manifest indirilemedi.'); }
  }

  // Controls
  btnPrev.addEventListener('click', ()=> slideTo(i-1, -1));
  btnNext.addEventListener('click', ()=> slideTo(i+1, +1));
  zl.addEventListener('click', ()=> slideTo(i-1, -1));
  zr.addEventListener('click', ()=> slideTo(i+1, +1));
  document.addEventListener('keydown', (ev)=>{
    if(ev.key==='ArrowLeft') slideTo(i-1, -1);
    else if(ev.key==='ArrowRight') slideTo(i+1, +1);
  });

  // Basic swipe (horizontal)
  let sx=0, sy=0, dx=0, dy=0, tracking=false;
  const SWIPE_X = 30; // px
  const SWIPE_Y = 60; // vertical tolerance
  document.addEventListener('touchstart', (e)=>{ const t=e.touches[0]; sx=t.clientX; sy=t.clientY; tracking=true; });
  document.addEventListener('touchmove',  (e)=>{ if(!tracking) return; const t=e.touches[0]; dx=t.clientX-sx; dy=t.clientY-sy; });
  document.addEventListener('touchend',   ()=>{
    if(tracking){
      if(Math.abs(dx)>SWIPE_X && Math.abs(dy)<SWIPE_Y){
        if(dx<0) slideTo(i+1, +1); else slideTo(i-1, -1);
      }
    }
    tracking=false; dx=dy=0;
  });

  load();
})();
</script>
</body>
</html>